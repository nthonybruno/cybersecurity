# Malware Analysis

## What is Malware?
Malware is any computer code designed to exploit vulnerabilities in other software from insecure design in an aim to cause destruction, deny access to others, steal  data and/or steal money.

Malware use cases include spying (keyloggers, remotely turn on webcam/microphone) or exfiltrating data (steal passwords, confidential documents).

Malware can also be used to encrypt data and demand a payment for decryption (Ransomware).

## [Types of Malware](https://www.crowdstrike.com/cybersecurity-101/malware/types-of-malware/)

1. **Trojan**
   - As the name implies, this malware needs a "horse" to hide inside in order gain access to the targets system. This is often done via malicious email attatchments or Microsoft Office Macros. Therefore, this commonly requires a social engineering attack to occur for the initial infection. Then, trojans often remain dormant while trying to spread across the network until triggered by an event like visiting a banking website.
   - _Uses_: Spying, data destruction, data exfiltration

2. **Adware**
   - Unwanted software that automatically displays or downloads advertising material, which is how the developer makes money. Often these advertisements are for sketchy websites and services, hence why they rely on illegal advertising tactics.
   - _Uses_: Get unwanted, sketchy advertisements on a users screen. Generally they hijack web browsing sessions and display ads then. 

3. **Spyware**
   - Software intended to spy on the user for malicious purposes.

4. **Rootkits/RATs**
   - a kind of malware that can give a threat actor control of your computer without your consent or knowledge.
5. **Ransomware**
   - Used to encrypt files to make them unaccessible and demand a payment (ransom) in return for decryption.
6. **Worms**
   - Worms are part of the Trojan process used to self-replicate across multiple devices on a network. 
7. **Keyloggers**
8. **Bots**
9. **Mobile**
10. **Wiper**
11. **Dropper**
   - Malware used to install other malware. This kind of malware takes care of the initial infection phase. An analogy would be that the dropper malware takes care of initially breaking into your house without you knowing, which can be difficult, and then opens your front door wide open for it's friends to walk right in while you sleep at night.

## What is Malware Analysis?
 Process of analyzing malware to understand it's purpose, scope of impact and signatures to be used for future detection and prevention.
 
__Considerations in the process of malware analysis__
 1. How did it initially infect the compromised machine?
 2. How does it hide from Anti-virus software?
 3. How does it interact with memory?
 4. Who/what does it communicate with?
 5. What type of malware is it?
 6. Is it a targeted attack?
 7. What can the malware do? What assets are at risk?

## Types of Malware Analysis
1. [Static Analysis](https://www.youtube.com/watch?v=ATflI5jX6Iw&list=PLBf0hzazHTGMSlOI2HZGc08ePwut6A2Io&index=5):
  - Process of analyzing malware without execution/running. 
  - Want to find as much metadata as possible which can be used for clues as to it's purpose, scope and expected behavior. 
  
  __Example Tactics__:
   1. Identify file type (PE, ELF, etc)
      - Portable Executable (PE) is the Windows file format. Could be in the form of a .dll or .exe
      - The file signature can be found in the *file header*. If you just look at the extension, can be mislead by double extensions like malware.exe.doc. Open the binary with a tool like HxD and look at the first 2 bytes. PE formats should show 4D 5A in the first two bytes and "MZ" in the decoded text. Can also look for the text "This program cannot be run in DOS mode" in the decoded text window.
      - ![malware_HXD_static_analysis_example](https://user-images.githubusercontent.com/44067716/203170849-87c0051d-dc6d-4a77-8c9f-08544b66c22c.png)
      - The PE header does not start until later. Look for "50 45" in hexadecimal table, and corresponding "PE" in the decoded text.
      - ![malware_HXD_static_analysis_example_PE_header_start](https://user-images.githubusercontent.com/44067716/203171218-c8f3079d-ae5d-45bb-a117-89f4046aa304.png)
      - *exeinfope* is a tool that comes with FlareVM and can handle this automatically.
      - *pestudio* and *CFF Explorer* are additional tools in FlareVM that can also determine this info automatically, as well as file type and cpu architecture (32bit, 64bit).

   2. Generate a hash of the malware and search online, see if anyone else has identified it (Can then compare the hash during/after execution to see if it has changed)
      - *hashmyfiles* and *hashcalc* can provide MD5, SHA-1 and SHA-256 hashes automatically
      - With this, you can create unique fingerprints for malware samples and check on sites like Virus Total to see if it has been detected previously.
   3. **Extracting Strings/Strings Analysis**
      - Extract readable words and strings from the malware for functionality.
      - Looking for filenames, URLs, Registry keys, IPs
      - Strings are ASCII and UNICODE format. 
      - Note: Attackers may intentionally include misleading strings to thwart analysis.
      - Available tools: Pestudio, peid, Shell Extensions, strings (CLI command. Example: "strings -a -n 6 <filepath>" will find all ascii strings in filepath of at least length 6)
   4. Try to deobfuscate or find a deobfuscator if it has been obfuscated ([UPX](https://upx.github.io/) is a popular packer)
      - A packer is a tool used to compress the executable and reduce the size and obfuscate it's content to make it difficult to analyze the behavior/function.
      - When an exeutable is executed, it is unpacked and exposes the initial contents of the binary.
      - In a packed binary using UPX, static analysis of extracting strings becomes extremely difficult or impossible as most of the strings will be turned into gibberish.
      - EXEinfo PE can be used to determine if a binary has been packed, as well as how to unpack/decompress it.
   5. PE Headers: The Portable Executable format is a file format for executables, object code, DLLs and others used in 32-bit and 64-bit versions of Windows operating systems. The PE format is a data structure that encapsulates the information necessary for the Windows OS loader to manage the wrapped executable code.
2. Dynamic Analysis:
  - Analyzing a programs behavior while it is running using a debugger
  - What is the malware doing?
3. Code analysis:
  - Analyzing a programs code. For malware, this involves reverse engineering, as the source code will not be readily accessiblle because it will have been compiled into an executable format.
4. Behavioral:
  - How does it interact with the file system/network while running?
  - Is it establishing any connections? Modifying the registry?

***
## Additional Resources
1. [Malware Analysis BootCamp](https://www.youtube.com/playlist?list=PLBf0hzazHTGMSlOI2HZGc08ePwut6A2Io) on YouTube by HackerSploit

***
## Tools
1. FlareVM
2. HxD - Hex Editor
3. Notepad++
4. ExeinfoPE - Retrieves window PE header information, as well as if the binary has been packed, the packer version, and how to unpack
5. Pestudio - 
6. CFF Explorer - 

***
## Best Practices
1. Use a Virtual Machine, and snapshot prior to downloading malware. Disable any shared drives and enable host-only network adapter.
2. Only download malware that is zipped and password protected to prevent accidental execution. Password is usually "infected" for malware samples.
